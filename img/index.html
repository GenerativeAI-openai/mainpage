<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë©€í‹° ë¯¸ë””ì–´ ì—…ë¡œë“œ & ê³µìœ </title>
  <style>
    body { margin:0; padding:1rem; font-family:sans-serif; background:#fafafa }
    .container { max-width:800px; margin:0 auto }
    h1 { text-align:center; margin-bottom:1rem }
    #upload-ui { display:none }
    .card {
      background:#fff; padding:1.5rem; border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    .field { margin-bottom:1rem }
    .field label { display:block; margin-bottom:0.3rem; font-weight:bold }
    .field input[type="text"],
    .field input[type="file"] {
      width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:4px;
    }
    .btn {
      width:100%; padding:0.75rem; background:#0070f3; color:#fff;
      border:none; border-radius:6px; font-size:1rem; cursor:pointer;
    }
    .btn:disabled { background:#999; cursor:not-allowed }
    .status { margin-top:0.5rem; font-size:0.9rem; color:#333 }
    #share-ui { display:none }
    .media-list {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(200px,1fr));
      gap:1rem;
    }
    .media-item { width:100%; border:1px solid #ddd; border-radius:6px; background:#fff }
    .media-item video, .media-item audio { width:100% }
    .context-menu {
      position:fixed; display:none; background:#fff;
      border:1px solid #ccc; box-shadow:0 2px 6px rgba(0,0,0,0.2);
      border-radius:4px; z-index:1000; padding:0.25rem 0;
    }
    .context-menu.visible { display:block }
    .context-menu ul { margin:0; padding:0; list-style:none }
    .context-menu li {
      padding:0.5rem 1.5rem; cursor:pointer; white-space:nowrap;
    }
    .context-menu li:hover { background:#f0f0f0 }
  </style>
</head>
<body>
<body>
  <div class="container">
    <h1 id="page-title"></h1>

    <!-- ì—…ë¡œë“œ UI -->
    <div id="upload-ui">
      <div class="card">
        <div class="field">
          <label for="customName">ì»¤ìŠ¤í…€ ë§í¬ ì´ë¦„ (ì„ íƒ)</label>
          <input type="text" id="customName" placeholder="ì˜ˆ: ë‚´_ì•¨ë²”_2025"/>
        </div>
        <div class="field">
          <label for="files">íŒŒì¼ ì„ íƒ (ì´ë¯¸ì§€Â·ì˜¤ë””ì˜¤Â·ë™ì˜ìƒ)</label>
          <input type="file" id="files" multiple accept="image/*,audio/*,video/*"/>
        </div>
        <button id="uploadBtn" class="btn" disabled>ì—…ë¡œë“œ ì‹œì‘</button>
        <div id="status" class="status"></div>
        <div id="links" class="status"></div>
      </div>
    </div>

    <!-- ê³µìœ  UI -->
    <div id="share-ui">
      <div class="media-list" id="media-list"></div>
    </div>
  </div>

  <!-- ìš°í´ë¦­ ë©”ë‰´ -->
  <nav id="context-menu" class="context-menu">
    <ul>
      <li data-action="copy">ì´ë¯¸ì§€ ë³µì‚¬</li>
      <li data-action="copy-link">ì´ë¯¸ì§€ ë§í¬ ë³µì‚¬</li>
      <li data-action="download">ë‹¤ìš´ë¡œë“œ</li>
      <li data-action="download-as">ì›í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ</li>
    </ul>
  </nav>

  <script type="module">
    // firebase-config.jsì—ì„œ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
    import firebaseConfig from './firebase-config.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const BASE = '/img';
    const path = location.pathname.replace(/\/+$/, '');
    const uploadUI = document.getElementById('upload-ui');
    const shareUI = document.getElementById('share-ui');
    const titleEl = document.getElementById('page-title');

    if (path === BASE) {
      // â€”â€” ì—…ë¡œë“œ ëª¨ë“œ â€”â€”
      titleEl.textContent = 'ë©€í‹° ë¯¸ë””ì–´ ì—…ë¡œë“œ';
      uploadUI.style.display = 'block';

      const fileInput = document.getElementById('files');
      const nameInput = document.getElementById('customName');
      const uploadBtn = document.getElementById('uploadBtn');
      const statusDiv = document.getElementById('status');
      const linksDiv = document.getElementById('links');
      let files = [];

      fileInput.addEventListener('change', e => {
        files = Array.from(e.target.files);
        uploadBtn.disabled = !files.length;
        statusDiv.textContent = '';
        linksDiv.innerHTML = '';
      });

      uploadBtn.addEventListener('click', async () => {
        if (!files.length) return;
        const raw = nameInput.value.trim();
        const customName = raw
          ? raw.replace(/[^0-9a-zA-Z\uAC00-\uD7A3\-]/g, '_')
          : '';
        uploadBtn.disabled = true;
        statusDiv.textContent = `ì—…ë¡œë“œ ì¤‘ (0/${files.length})`;
        linksDiv.innerHTML = '';

        const ids = [];
        const uploadInfos = [];

        for (let i = 0; i < files.length; i++) {
          const f = files[i];
          const filename = `${Date.now()}_${f.name}`;
          try {
            const dataUrl = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result);
              reader.onerror = reject;
              reader.readAsDataURL(f);
            });
            uploadInfos.push({
              filename,
              mimeType: f.type,
              dataUrl,
              uploadedAt: Date.now()
            });
            ids.push(customName || filename);
            linksDiv.innerHTML += `<div>âœ… ${f.name} ì¤€ë¹„ ì™„ë£Œ</div>`;
          } catch (err) {
            linksDiv.innerHTML += `<div>âŒ ${f.name} ì—…ë¡œë“œ ì‹¤íŒ¨</div>`;
          }
          statusDiv.textContent = `ì—…ë¡œë“œ ì¤‘ (${i + 1}/${files.length})`;
        }

        const docKey = customName || ids[0];
        await setDoc(doc(db, 'uploads', docKey), {
          files: uploadInfos,
          createdAt: Date.now()
        });

        if (customName) {
          linksDiv.innerHTML = `
            âœ… ì»¤ìŠ¤í…€ ë§í¬:<br/>
            <a href="https://kkomaweb.com/img/${customName}" target="_blank">
              https://kkomaweb.com/img/${customName}
            </a>`;
        } else {
          linksDiv.innerHTML = 'ğŸ”— ê¸°ë³¸ ë§í¬ ëª©ë¡:<br/>';
          ids.forEach(id => {
            linksDiv.innerHTML += `
              <a href="https://kkomaweb.com/img/${id}" target="_blank">
                https://kkomaweb.com/img/${id}
              </a><br/>`;
          });
        }

        statusDiv.textContent = 'ì™„ë£Œ!';
        uploadBtn.disabled = false;
      });

    } else if (path.startsWith(BASE + '/')) {
      // â€”â€” ê³µìœ  ë³´ê¸° ëª¨ë“œ â€”â€”
      const key = decodeURIComponent(path.slice((BASE + '/').length));
      titleEl.textContent = 'ê³µìœ  ë¯¸ë””ì–´ ë³´ê¸°';
      shareUI.style.display = 'block';

      let items = [];
      try {
        const docSnap = await getDoc(doc(db, 'uploads', key));
        if (docSnap.exists()) {
          items = docSnap.data().files || [];
        } else {
          items = [];
        }
      } catch (e) {
        items = [];
      }

      const list = document.getElementById('media-list');
      if (!items.length) {
        list.innerHTML = '<div>âŒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      items.forEach(item => {
        const ext = item.filename.split('.').pop().toLowerCase();
        let el;
        if (item.mimeType.startsWith('video') || ['mp4', 'webm', 'ogg'].includes(ext)) {
          el = document.createElement('video'); el.controls = true;
        } else if (item.mimeType.startsWith('audio') || ['mp3', 'wav', 'aac', 'ogg'].includes(ext)) {
          el = document.createElement('audio'); el.controls = true;
        } else {
          el = document.createElement('img');
        }
        el.src = item.dataUrl;
        el.dataset.filename = item.filename;
        el.classList.add('media-item');
        list.appendChild(el);
      });

      // â€”â€” ìš°í´ë¦­ ë©”ë‰´ â€”â€” 
      const menu = document.getElementById('context-menu');
      let targetImg = null;
      list.addEventListener('contextmenu', e => {
        if (e.target.tagName !== 'IMG') return;
        e.preventDefault();
        targetImg = e.target;
        menu.style.top = e.clientY + 'px';
        menu.style.left = e.clientX + 'px';
        menu.classList.add('visible');
      });
      document.addEventListener('click', () => menu.classList.remove('visible'));
      menu.addEventListener('click', async e => {
        const action = e.target.dataset.action;
        if (!targetImg) return;
        const rawUrl = targetImg.src;
        if (action === 'copy') {
          const blob = await fetch(rawUrl).then(r => r.blob());
          await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
        }
        if (action === 'copy-link') {
          await navigator.clipboard.writeText(rawUrl);
        }
        if (action === 'download') {
          const a = document.createElement('a');
          a.href = rawUrl;
          a.download = targetImg.dataset.filename;
          a.click();
        }
        if (action === 'download-as') {
          const ext = prompt('í™•ì¥ì ì…ë ¥ (png, jpg, mp4, mp3 ë“±):', targetImg.dataset.filename.split('.').pop());
          if (ext) {
            const a = document.createElement('a');
            a.href = rawUrl;
            a.download = `file.${ext}`;
            a.click();
          }
        }
        menu.classList.remove('visible');
      });
    }
  </script>
</body>
</html>
